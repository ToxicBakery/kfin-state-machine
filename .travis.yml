sudo: required

language: ruby

install:
- true

env:
  DOCKER_IMAGE=openjdk:8-alpine

before_script:
- chmod +x gradlew
- echo "Travis branch is $TRAVIS_BRANCH"
- echo "Travis branch is in pull request? $TRAVIS_PULL_REQUEST"
- echo "Travis tag $TRAVIS_TAG"
- "docker pull $DOCKER_IMAGE"

stages:
  - name: compile
  - name: deploy
    if: tag IS present OR branch = master

jobs:
  include:
    - stage: compile
      script: "docker run -it -v $PWD:/workspace $DOCKER_IMAGE /bin/sh -c \"cd /workspace && ./gradlew clean test\""
    - stage: deploy
      script:
      - openssl aes-256-cbc -K $encrypted_f3f9bf37f66c_key -iv $encrypted_f3f9bf37f66c_iv
         -in maven.keystore.gpg.enc -out maven.keystore.gpg -d
      - echo -e "signing.keyId=${SIGNING_KEY}" >> "gradle.properties"
      - echo -e "signing.password=${SIGNING_PASSWORD}" >> "gradle.properties"
      - echo -e "signing.secretKeyRingFile=../maven.keystore.gpg" >> "gradle.properties"
      - "docker run -it -v $PWD:/workspace $DOCKER_IMAGE /bin/sh -c \"cd /workspace && ./gradlew uploadArchives\""
